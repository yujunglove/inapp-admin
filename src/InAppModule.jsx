// InAppModule.jsx - CDN CSS + Î°úÏª¨ JS ÌïòÏù¥Î∏åÎ¶¨Îìú (ÏµúÏ¢Ö Î≤ÑÏ†Ñ)
import React, { useEffect, useRef, useState } from 'react';
import {
    ModuleWrapper,
    ContentSection,
    Header,
    HeaderIcon,
    StepTitle,
    StepNumber,
    ContentArea,
    PreviewSection
} from './styles/StyledComponents';

import {
    DisplayIcon
} from './components/Icons';

// ÏÑúÎπÑÏä§ import
import { InAppService } from './services/inAppService';

// Í≥µÌÜµÏΩîÎìú Í∏∞Î∞ò ÏÑ§Ï†ï Îç∞Ïù¥ÌÑ∞
const DISPLAY_TYPES = {
    BAR: {
        name: "Î∞îÌòï",
        defaultLocation: "TOP",
        themes: [
            { code: "T1", name: "Ïù¥ÎØ∏ÏßÄÌòï", template: "M1" },
            { code: "T2", name: "ÌÖçÏä§Ìä∏Ìòï", template: "M2" },
            { code: "T3", name: "Ïù¥ÎØ∏ÏßÄ + ÌÖçÏä§Ìä∏Ìòï", template: "M3" }
        ]
    },
    BOX: {
        name: "Î∞ïÏä§Ìòï",
        defaultLocation: "MID",
        themes: [
            { code: "T4", name: "Ïù¥ÎØ∏ÏßÄÌòï", template: "M1" },
            { code: "T5", name: "Ïù¥ÎØ∏ÏßÄÌòï + Î≤ÑÌäº1", template: "M4" },
            { code: "T6", name: "Ïù¥ÎØ∏ÏßÄÌòï + Î≤ÑÌäº2", template: "M5" },
            { code: "T7", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏", template: "M3" },
            { code: "T8", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº1", template: "M6" },
            { code: "T9", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº2", template: "M7" }
        ]
    },
    SLIDE: {
        name: "Ïä¨ÎùºÏù¥ÎìúÌòï",
        defaultLocation: "MID",
        themes: [
            { code: "T10", name: "Ïù¥ÎØ∏ÏßÄÌòï", template: "M1" },
            { code: "T11", name: "Ïù¥ÎØ∏ÏßÄÌòï + Î≤ÑÌäº1", template: "M4" },
            { code: "T12", name: "Ïù¥ÎØ∏ÏßÄÌòï + Î≤ÑÌäº2", template: "M5" },
            { code: "T13", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏", template: "M3" },
            { code: "T14", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº1", template: "M6" },
            { code: "T15", name: "Ïù¥ÎØ∏ÏßÄÌòï + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº2", template: "M7" }
        ]
    },
    STAR: {
        name: "Î≥ÑÏ†êÌòï",
        defaultLocation: "BOT",
        themes: [
            { code: "T16", name: "ÌÖçÏä§Ìä∏Ìòï", template: "M8" }
        ]
    }
};

const TEMPLATE_CONFIG = {
    M1: { name: "Ïù¥ÎØ∏ÏßÄ", hasImage: true, hasText: false, buttonCount: 0 },
    M2: { name: "ÌÖçÏä§Ìä∏", hasImage: false, hasText: true, buttonCount: 0 },
    M3: { name: "Ïù¥ÎØ∏ÏßÄ + ÌÖçÏä§Ìä∏", hasImage: true, hasText: true, buttonCount: 0 },
    M4: { name: "Ïù¥ÎØ∏ÏßÄ + Î≤ÑÌäº 1", hasImage: true, hasText: false, buttonCount: 1 },
    M5: { name: "Ïù¥ÎØ∏ÏßÄ + Î≤ÑÌäº 2", hasImage: true, hasText: false, buttonCount: 2 },
    M6: { name: "Ïù¥ÎØ∏ÏßÄ + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº 1", hasImage: true, hasText: true, buttonCount: 1 },
    M7: { name: "Ïù¥ÎØ∏ÏßÄ + ÌÖçÏä§Ìä∏ + Î≤ÑÌäº 2", hasImage: true, hasText: true, buttonCount: 2 },
    M8: { name: "ÏÑ§Î¨∏", hasImage: false, hasText: true, buttonCount: 0 }
};

// ÌëúÏãúÌòïÌÉúÎ≥Ñ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò
const createDefaultData = (displayType, themeCode = null, templateCode = null) => {
    const displayConfig = DISPLAY_TYPES[displayType];
    if (!displayConfig) return null;

    const selectedTheme = themeCode
        ? displayConfig.themes.find(t => t.code === themeCode)
        : displayConfig.themes[0];

    if (!selectedTheme) return null;

    const template = templateCode || selectedTheme.template;
    const templateConfig = TEMPLATE_CONFIG[template];

    const show = [];
    if (templateConfig.hasImage) show.push("images");
    if (templateConfig.hasText) show.push("msg");
    if (templateConfig.buttonCount > 0) show.push("buttons");

    const defaultImages = templateConfig.hasImage ? [{
        seq: 1,
        url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQhFjJgDxmK9CVk3XxTiitDyZLIOKJvtZNLrg&s",
        action: "L",
        linkUrl: "http://www.naver.com",
        linkOpt: "B"
    }] : [];

    const defaultButtons = [];
    for (let i = 0; i < templateConfig.buttonCount; i++) {
        defaultButtons.push({
            seq: i + 1,
            text: `Î≤ÑÌäº ${i + 1}`,
            linkUrl: "http://www.example.com",
            linkOpt: "B"
        });
    }

    return {
        display: displayType,
        theme: selectedTheme.code,
        template: template,
        show: show,
        location: displayConfig.defaultLocation,
        images: defaultImages,
        msg: {
            title: `${displayConfig.name} ÌÖåÏä§Ìä∏`,
            text: `${selectedTheme.name} Ïä§ÌÉÄÏùºÏûÖÎãàÎã§.`
        },
        today: "Y",
        buttons: defaultButtons
    };
};

const InAppModule = ({
                         config = {},
                         onDataChange = () => {},
                         initialData = null
                     }) => {
    // Ï∞∏Ï°∞Îì§
    const previewIframeRef = useRef();

    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌÉÄÏûÖÍ≥º ÎØ∏Î¶¨Î≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞
    const [currentType, setCurrentType] = useState('BOX');
    const [currentTheme, setCurrentTheme] = useState('T4');
    const [previewData, setPreviewData] = useState(() => createDefaultData('BOX'));
    const [useLocalVersion, setUseLocalVersion] = useState(false);

    // ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
    const handleTypeChange = (type) => {
        setCurrentType(type);
        const defaultTheme = DISPLAY_TYPES[type].themes[0].code;
        setCurrentTheme(defaultTheme);
        const newData = createDefaultData(type, defaultTheme);
        setPreviewData(newData);
        console.log(`üîÑ ${type}ÌòïÏúºÎ°ú Î≥ÄÍ≤Ω:`, newData);
    };

    // ÌÖåÎßà Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
    const handleThemeChange = (themeCode) => {
        setCurrentTheme(themeCode);
        const newData = createDefaultData(currentType, themeCode);
        setPreviewData(newData);
        console.log(`üé® ÌÖåÎßà Î≥ÄÍ≤Ω ${themeCode}:`, newData);
    };

    // ÏµúÏ¥à Î°úÎìú
    useEffect(() => {
        const defaultData = createDefaultData('BOX');
        console.log('üé® ÏµúÏ¥à BOX ÎØ∏Î¶¨Î≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', defaultData);
    }, []);

    // ÎØ∏Î¶¨Î≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
    useEffect(() => {
        if (previewData && previewIframeRef.current?.contentWindow) {
            try {
                previewIframeRef.current.contentWindow.postMessage({
                    type: 'show_preview',
                    data: previewData,
                    useLocal: useLocalVersion
                }, '*');
                console.log('üì§ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†ÑÏÜ° ÏôÑÎ£å:', previewData);
            } catch (error) {
                console.error('ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†ÑÏÜ° Ïã§Ìå®:', error);
            }
        }
    }, [previewData, useLocalVersion]);

    // iframe onLoad Ïù¥Î≤§Ìä∏
    const handleIframeLoad = () => {
        console.log('üì± iframe Î°úÎìú ÏôÑÎ£å');
        if (previewData) {
            try {
                previewIframeRef.current.contentWindow.postMessage({
                    type: 'show_preview',
                    data: previewData,
                    useLocal: useLocalVersion
                }, '*');
                console.log('üì§ Ï¥àÍ∏∞ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†ÑÏÜ°:', previewData);
            } catch (error) {
                console.error('Ï¥àÍ∏∞ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†ÑÏÜ° Ïã§Ìå®:', error);
            }
        }
    };

    // Ï†ÑÏ≤¥ÌôîÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞ Ìï∏Îì§Îü¨
    const handleFullScreenPreview = () => {
        if (previewData) {
            InAppService.showPreview(previewData);
        } else {
            alert('ÎØ∏Î¶¨Î≥¥Í∏∞Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
    };

    // Ïò§ÎäòÌïòÎ£® Î≥¥ÏßÄÏïäÍ∏∞ ÌÜ†Í∏Ä
    const handleTodayChange = (checked) => {
        const updatedData = {
            ...previewData,
            today: checked ? 'Y' : 'N'
        };
        setPreviewData(updatedData);
    };

    return (
        <div className="qdx_adm_wrap">
            <ModuleWrapper>
                <ContentSection>
                    <Header>
                        <HeaderIcon>
                            <DisplayIcon />
                        </HeaderIcon>
                        <div style={{ flex: 1 }}>
                            <StepTitle>
                                QDX ÌÖåÏä§Ìä∏ - {currentType}Ìòï ({useLocalVersion ? 'Î°úÏª¨' : 'CDN'})
                            </StepTitle>
                            <p style={{
                                color: '#6b7280',
                                fontSize: '14px',
                                margin: '4px 0 0 0',
                                fontWeight: '400'
                            }}>
                                {useLocalVersion ? 'CDN CSS + Î°úÏª¨ JS' : 'ÏôÑÏ†Ñ CDN Î≤ÑÏ†Ñ'}
                            </p>
                        </div>
                        <StepNumber>
                            1/1
                        </StepNumber>
                    </Header>

                    <ContentArea style={{
                        maxHeight: 'calc(100vh - 140px)',
                        overflowY: 'auto',
                        overflowX: 'hidden'
                    }}>
                        <div style={{
                            padding: '20px',
                            background: 'white',
                            borderRadius: '8px',
                            border: '1px solid #e2e8f0'
                        }}>
                            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', color: '#374151' }}>
                                QDX ÌÖåÏä§Ìä∏ ÏÑ§Ï†ï
                            </h3>

                            {/* Î≤ÑÏ†Ñ ÏÑ†ÌÉù */}
                            <div style={{ marginBottom: '20px' }}>
                                <h4 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>
                                    Î≤ÑÏ†Ñ ÏÑ†ÌÉù
                                </h4>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button
                                        onClick={() => setUseLocalVersion(false)}
                                        style={{
                                            padding: '8px 16px',
                                            background: !useLocalVersion ? '#10b981' : '#f1f5f9',
                                            color: !useLocalVersion ? 'white' : '#374151',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        CDN Î≤ÑÏ†Ñ (ÏôÑÏ†Ñ ÏûëÎèô)
                                    </button>
                                    <button
                                        onClick={() => setUseLocalVersion(true)}
                                        style={{
                                            padding: '8px 16px',
                                            background: useLocalVersion ? '#f59e0b' : '#f1f5f9',
                                            color: useLocalVersion ? 'white' : '#374151',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Î°úÏª¨ JS + CDN CSS
                                    </button>
                                </div>
                            </div>

                            {/* ÌÉÄÏûÖ ÏÑ†ÌÉù Î≤ÑÌäºÎì§ */}
                            <div style={{
                                display: 'flex',
                                gap: '8px',
                                marginBottom: '20px',
                                flexWrap: 'wrap'
                            }}>
                                {Object.keys(DISPLAY_TYPES).map((type) => (
                                    <button
                                        key={type}
                                        onClick={() => handleTypeChange(type)}
                                        style={{
                                            padding: '8px 16px',
                                            background: currentType === type ? '#3b82f6' : '#f1f5f9',
                                            color: currentType === type ? 'white' : '#374151',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            fontWeight: currentType === type ? '600' : '400'
                                        }}
                                    >
                                        {DISPLAY_TYPES[type].name}
                                    </button>
                                ))}
                            </div>

                            {/* ÌÖåÎßà ÏÑ†ÌÉù */}
                            <div style={{ marginBottom: '20px' }}>
                                <h4 style={{ margin: '0 0 12px 0', fontSize: '16px', color: '#374151' }}>
                                    ÌÖåÎßà ÏÑ†ÌÉù
                                </h4>
                                <div style={{
                                    display: 'flex',
                                    gap: '8px',
                                    flexWrap: 'wrap'
                                }}>
                                    {DISPLAY_TYPES[currentType]?.themes.map((theme) => (
                                        <button
                                            key={theme.code}
                                            onClick={() => handleThemeChange(theme.code)}
                                            style={{
                                                padding: '6px 12px',
                                                background: currentTheme === theme.code ? '#10b981' : '#ffffff',
                                                color: currentTheme === theme.code ? 'white' : '#374151',
                                                border: '1px solid #e2e8f0',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                fontWeight: currentTheme === theme.code ? '600' : '400'
                                            }}
                                        >
                                            {theme.code}: {theme.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ÏÑ†ÌÉùÎêú ÌÉÄÏûÖ Ï†ïÎ≥¥ */}
                            <div style={{
                                background: '#f8fafc',
                                padding: '16px',
                                borderRadius: '6px',
                                marginBottom: '16px',
                                border: '1px solid #e2e8f0'
                            }}>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÌëúÏãúÌòïÌÉú:</strong> {previewData.display}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÌÖåÎßà:</strong> {previewData.theme}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÌÖúÌîåÎ¶ø:</strong> {previewData.template}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÏúÑÏπò:</strong> {previewData.location}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÌëúÏãú ÏöîÏÜå:</strong> {previewData.show.join(', ')}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>Ï†úÎ™©:</strong> {previewData.msg.title}
                                </div>
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ÎÇ¥Ïö©:</strong> {previewData.msg.text}
                                </div>

                                {previewData.images && previewData.images.length > 0 && (
                                    <div style={{ marginBottom: '8px' }}>
                                        <strong>Ïù¥ÎØ∏ÏßÄ Í∞úÏàò:</strong> {previewData.images.length}Í∞ú
                                    </div>
                                )}

                                {previewData.buttons && previewData.buttons.length > 0 && (
                                    <div style={{ marginBottom: '8px' }}>
                                        <strong>Î≤ÑÌäº:</strong> {previewData.buttons.map(btn => btn.text).join(', ')}
                                    </div>
                                )}
                            </div>

                            <button
                                onClick={handleFullScreenPreview}
                                style={{
                                    padding: '10px 20px',
                                    background: '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '14px'
                                }}
                            >
                                Ï†ÑÏ≤¥ÌôîÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞
                            </button>
                        </div>
                    </ContentArea>
                </ContentSection>

                {/* ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÑπÏÖò */}
                <PreviewSection>
                    {/* Ìó§Îçî */}
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '20px',
                        paddingBottom: '16px',
                    }}>
                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                            {/* Ïò§ÎäòÌïòÎ£® Î≥¥ÏßÄÏïäÍ∏∞ Ï≤¥ÌÅ¨Î∞ïÏä§ */}
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                cursor: 'pointer',
                                fontSize: '14px',
                                color: '#374151'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={previewData?.today === 'Y'}
                                    onChange={(e) => handleTodayChange(e.target.checked)}
                                    style={{
                                        width: '16px',
                                        height: '16px',
                                        cursor: 'pointer'
                                    }}
                                />
                                Ïò§ÎäòÌïòÎ£® Î≥¥ÏßÄÏïäÍ∏∞
                            </label>

                            {/* Ï†ÑÏ≤¥ÌôîÎ©¥ Î≤ÑÌäº */}
                            <button
                                onClick={handleFullScreenPreview}
                                style={{
                                    padding: '10px 10px',
                                    background: '#169DAF',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '50%',
                                    fontSize: '14px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    transition: 'all 0.2s ease',
                                    marginLeft: '12px'
                                }}
                            >
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    {/* QDX ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                    <iframe
                        ref={previewIframeRef}
                        onLoad={handleIframeLoad}
                        style={{
                            width: '100%',
                            flex: 1,
                            border: 'none',
                            background: 'transparent',
                            minHeight: '400px'
                        }}
                        srcDoc={`
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>QDX Test</title>
    <!-- CDN CSSÎäî Ìï≠ÏÉÅ Î°úÎìú -->
    <link rel="stylesheet" href="https://quadmax.co.kr/qdx/css/qdx.css">
    <link rel="stylesheet" href="https://quadmax.co.kr/qdx/css/qdx-theme.css">
    
    <style>
#qdx_popup_wrap {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #fafafa !important;
    z-index: 2147483647 !important;
    display: block !important;
    overflow: auto !important;
}

#qdx_type_box,
#qdx_type_slide {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-60%, -60%) scale(0.5) !important;
    transform-origin: center center !important;
}

#qdx_type_bar {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-60%, -60%) scale(0.9) !important;
    transform-origin: center center !important;
}

#qdx_type_star {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) scale(0.7) !important;
    transform-origin: center center !important;
}

.qdx_cont {
    box-shadow: 0 8px 32px rgba(0,0,0,0.22) !important;
    border-radius: 18px !important;
}
    </style>
</head>

<body>
    <!-- CDN JSÎäî Í∏∞Î≥∏ÏúºÎ°ú Î°úÎìú -->
    <script src="https://quadmax.co.kr/qdx/qdx-renderer.js"></script>
    
    <script>
        let cdnQdx = null;
        let localQdx = null;
        let qdxReady = false;
        let pendingPreview = null;
        let useLocalVersion = false;
        
        async function initQdx() {
            try {
                // CDN QDX Ï¥àÍ∏∞Ìôî
                if (window.qdx && typeof window.qdx.init === 'function') {
                    await window.qdx.init({
                        "api_key": "8jaAWd0Zp7POcZYLWDBdCg==",
                        "cntnrId": "easycore",
                        "serverUrl": "https://quadmax.co.kr"
                    });
                    cdnQdx = window.qdx;
                    console.log('‚úÖ CDN QDX Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                } else {
                    console.log('‚è≥ CDN QDX Î°úÎìú ÎåÄÍ∏∞...');
                    setTimeout(initQdx, 100);
                    return;
                }
                
                // Î°úÏª¨ QDX Î°úÎìú ÏãúÎèÑ
                await loadLocalQdx();
                
            } catch (error) {
                console.error('‚ùå QDX Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                setTimeout(initQdx, 500);
            }
        }
        
        async function loadLocalQdx() {
            try {
                const script = document.createElement('script');
                script.src = '../src/assets/qdx-renderer.js.umd.cjs';
                script.onload = () => {
                    setTimeout(() => {
                        if (window.QdxRenderer && window.QdxRenderer !== cdnQdx) {
                            localQdx = window.QdxRenderer;
                            console.log('‚úÖ Î°úÏª¨ QDX Î°úÎìú ÏôÑÎ£å');
                        }
                        
                        qdxReady = true;
                        if (pendingPreview) {
                            showPreview(pendingPreview.data, pendingPreview.useLocal);
                            pendingPreview = null;
                        }
                    }, 100);
                };
                
                script.onerror = () => {
                    console.log('‚ùå Î°úÏª¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®, CDNÎßå ÏÇ¨Ïö©');
                    qdxReady = true;
                    if (pendingPreview) {
                        showPreview(pendingPreview.data, false);
                        pendingPreview = null;
                    }
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('‚ùå Î°úÏª¨ QDX Î°úÎìú Ïã§Ìå®:', error);
                qdxReady = true;
            }
        }
        
        function showPreview(data, useLocal = false) {
            if (!data) {
                console.log('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                return;
            }
            
            if (!qdxReady) {
                console.log('‚è≥ QDX Ï§ÄÎπÑ Ï§ë...');
                pendingPreview = { data, useLocal };
                return;
            }
            
            try {
                // Í∏∞Ï°¥ ÌåùÏóÖ Ï†úÍ±∞
                const existingPopup = document.getElementById('qdx_popup_wrap');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                const qdxToUse = (useLocal && localQdx) ? localQdx : cdnQdx;
                const version = (useLocal && localQdx) ? 'Î°úÏª¨ JS' : 'CDN';
                
                console.log(\`üì± ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú (\${version}):, data\`);
                const messageId = 'PREVIEW_' + Date.now();
                qdxToUse.showMsg(messageId, data);
                
            } catch (error) {
                console.error('‚ùå ÎØ∏Î¶¨Î≥¥Í∏∞ Ïã§Ìå®:', error);
            }
        }
        
        window.addEventListener('message', function (e) {
            if (e.data.type === 'show_preview' && e.data.data) {
                console.log('üì® Î©îÏãúÏßÄ ÏàòÏã†:', e.data.data);
                showPreview(e.data.data, e.data.useLocal);
            }
        });
        
        // Ï¥àÍ∏∞Ìôî ÏãúÏûë
        initQdx();
    </script>
</body>
</html>
                        `}
                        title="QDX Test"
                        sandbox="allow-scripts allow-same-origin"
                    />
                </PreviewSection>

            </ModuleWrapper>
        </div>
    );
};

export default InAppModule;